@startuml
' C4-PlantUML: Request / Traffic Flow (Two AKS clusters + Traffic Manager + Ingress)
' Requires C4-PlantUML library if you want to render diagrams:
' https://github.com/plantuml-stdlib/C4-PlantUML

!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

LAYOUT_TOP_DOWN()

title Request / Traffic Flow: Internet -> Traffic Manager -> AKS A/B -> Ingress -> Service -> Pods

Person(user, "User / Client", "Browser or curl")

System_Boundary(azure, "Azure") {

  System(trafficManager, "Azure Traffic Manager", "DNS-based global routing", "Returns IP_A or IP_B based on endpoint health (priority failover)")

  System_Boundary(clusterA, "AKS Cluster A (Region A)") {

    Container(lbA, "Azure Load Balancer (Public)", "L4 TCP load balancer", "Public IP_A. Forwards 80/443 to cluster nodes / NodePorts")
    Container(ingA, "ingress-nginx controller", "NGINX Ingress Controller (pods)", "L7 reverse proxy. Terminates TLS, routes by Ingress rules")
    Container(svcHelloA, "Service hello", "Kubernetes Service (ClusterIP)", "Stable virtual IP; load-balances to hello pods")
    Container(podHelloA1, "hello pod #1", "nginx:1.27", "Serves / and /healthz")
    Container(podHelloA2, "hello pod #2", "nginx:1.27", "Serves / and /healthz")
    Container(podHelloA3, "hello pod #3", "nginx:1.27", "Optional (HPA may scale)")

    Container(hpaA, "HPA hello", "HorizontalPodAutoscaler", "Scales hello Deployment based on CPU (min 2, max 6)")
    Container(lawA, "Log Analytics Workspace", "Azure Monitor / Container Insights", "Collects logs/metrics (oms_agent)")
  }

  System_Boundary(clusterB, "AKS Cluster B (Region B)") {

    Container(lbB, "Azure Load Balancer (Public)", "L4 TCP load balancer", "Public IP_B. Forwards 80/443 to cluster nodes / NodePorts")
    Container(ingB, "ingress-nginx controller", "NGINX Ingress Controller (pods)", "L7 reverse proxy. Terminates TLS, routes by Ingress rules")
    Container(svcHelloB, "Service hello", "Kubernetes Service (ClusterIP)", "Stable virtual IP; load-balances to hello pods")
    Container(podHelloB1, "hello pod #1", "nginx:1.27", "Serves / and /healthz")
    Container(podHelloB2, "hello pod #2", "nginx:1.27", "Serves / and /healthz")
    Container(podHelloB3, "hello pod #3", "nginx:1.27", "Optional (HPA may scale)")

    Container(hpaB, "HPA hello", "HorizontalPodAutoscaler", "Scales hello Deployment based on CPU (min 2, max 6)")
    Container(lawB, "Log Analytics Workspace", "Azure Monitor / Container Insights", "Same workspace can be used for MVP")
  }
}

' --- DNS-level selection
Rel(user, trafficManager, "Resolve DNS name (e.g., tm-devops-ilar.trafficmanager.net)", "DNS")
Rel(trafficManager, lbA, "Returns IP_A when A is healthy", "DNS answer")
Rel(trafficManager, lbB, "Returns IP_B on failover (A unhealthy)", "DNS answer")

' --- Cluster A request path
Rel(user, lbA, "HTTPS/HTTP request to IP_A", "TCP 443/80")
Rel(lbA, ingA, "Forward to NodePort -> ingress-nginx pods", "L4")
Rel(ingA, svcHelloA, "Route / to Service hello", "HTTP")
Rel(svcHelloA, podHelloA1, "Load-balance to endpoints", "HTTP")
Rel(svcHelloA, podHelloA2, "Load-balance to endpoints", "HTTP")
Rel(svcHelloA, podHelloA3, "Load-balance to endpoints (if exists)", "HTTP")

Rel(hpaA, svcHelloA, "Scales hello Deployment replicas (min 2 / max 6)", "K8s control-plane")
Rel(ingA, lawA, "Logs/metrics shipped (Container Insights)", "Telemetry")
Rel(svcHelloA, lawA, "Logs/metrics shipped (Container Insights)", "Telemetry")

' --- Cluster B request path (same)
Rel(user, lbB, "HTTPS/HTTP request to IP_B", "TCP 443/80")
Rel(lbB, ingB, "Forward to NodePort -> ingress-nginx pods", "L4")
Rel(ingB, svcHelloB, "Route / to Service hello", "HTTP")
Rel(svcHelloB, podHelloB1, "Load-balance to endpoints", "HTTP")
Rel(svcHelloB, podHelloB2, "Load-balance to endpoints", "HTTP")
Rel(svcHelloB, podHelloB3, "Load-balance to endpoints (if exists)", "HTTP")

Rel(hpaB, svcHelloB, "Scales hello Deployment replicas (min 2 / max 6)", "K8s control-plane")
Rel(ingB, lawB, "Logs/metrics shipped (Container Insights)", "Telemetry")
Rel(svcHelloB, lawB, "Logs/metrics shipped (Container Insights)", "Telemetry")

@enduml
